# Лабораторная работа 4. Параллельная реализация метода Якоби в трехмерной области

## Цель работы

Практическое освоение методов распараллеливания численных алгоритмов на регулярных сетках на примере реализации метода Якоби в трехмерной области.

## Постановка задачи

Требуется решить уравнение (найти функцию $\phi$):

$$(1) \quad \frac{\partial^2 \phi}{\partial x^2} + \frac{\partial^2 \phi}{\partial y^2} + \frac{\partial^2 \phi}{\partial z^2} - a\phi = \rho, \quad a\geqslant0, \quad \phi=\phi (x, y, z), \quad  \rho=\rho (x, y, z)$$

в области $\Omega$ с краевыми условиями 1-го рода (на границе $G$ известны значения искомой функции $\phi$):

$$\phi \mid_G = F(x, y, z)$$

Область $\Omega$ имеет вид прямоугольного параллелепипеда с размерами $D_x × D_y × D_z$

![Область решения Ω](https://user-images.githubusercontent.com/90527574/230924360-95b4ba3c-4a54-407d-9f7c-1ece3e9e6e4a.png)

Для численного решения задачи необходимо перейти к ее дискретному аналогу. Для этого введем в области $\Omega$ равномерную прямоугольную сетку размером $N_x × N_y × N_z$ узлов. Шаги сетки (расстояния между соседними узлами) по осям $X$, $Y$, $Z$ будут равны:

$$h_x = \frac{D_x}{N_x-1}, \quad h_y = \frac{D_y}{N_y-1}, \quad h_z = \frac{D_z}{N_z-1} $$

Тогда координаты узла с произвольными индексами $i, j, k$ вычисляются следующим образом:

$$x_i = x_0 + ih_x,$$
$$y_j = y_0 + jh_y,$$
$$z_k = z_0 + kh_z,$$

где $x_0$, $y_0$, $z_0$ – начальные координаты области $\Omega$, $i \in [0, N_x],$ $j \in [0, N_y],$ $k \in [0, N_z]$. Вместо непрерывных функций $\phi(x,y,z)$, $\rho(x,y,z)$, $F(x,y,z)$ в области $\Omega$ вводятся сеточные функции $\phi_{i,j,k}$, $\rho_{i,j,k}$, $F_{i,j,k}$, заданные в узлах сетки:

$$\phi_{i, j, k}=\phi(x_i, y_j, z_k),$$
$$\rho_{i, j, k}=\rho(x_i, y_j, z_k),$$
$$F_{i, j, k}=F(x_i, y_j, z_k),$$

На выбранной сетке запишем разностную схему – дискретный аналог уравнения (1):

$$\frac{\phi_{i+1, j, k}-2\phi_{i, j, k}+\phi_{i-1, j, k}}{h_x^2}+\frac{\phi_{i, j+1, k}-2\phi_{i, j, k}+\phi_{i, j-1, k}}{h_y^2}+\frac{\phi_{i, j, k+1}-2\phi_{i, j, k}+\phi_{i, j, k-1}}{h_z^2}-a\phi_{i, j, k}=\rho_{i, j, k}$$

Полученная разностная схема связывает значения искомой функции в узлах сетки в некоторой локальной окрестности. Если выразить из нее $\phi_{i, j, k}$, можно получить формулу для итерационного процесса метода Якоби (здесь $m$ – номер итерации):

$$(2) \quad \phi_{i, j, k}^{m+1}=\frac{\frac{\phi_{i+1, j, k}^m+\phi_{i-1, j, k}^m}{h_x^2}+\frac{\phi_{i, j+1, k}^m+\phi_{i, j-1, k}^m}{h_y^2}+\frac{\phi_{i, j, k+1}^m+\phi_{i, j, k-1}^m}{h_z^2}-\rho_{i, j, k}}{\frac{2}{h_x^2}+\frac{2}{h_y^2}+\frac{2}{h_z^2}+a}$$

Если, начиная с некоторого начального приближения, многократно перевычислять значения $\phi_{i, j, k}$ по формуле (2), то они будут постепенно приближаться к искомому решению. Условие завершения итерационного процесса по достижению некоторого порога сходимости:

$$(3) \quad \max_{i, j, k}\mid \phi_{i, j, k}^{m+1} - \phi_{i, j, k}^{m} \mid < \varepsilon$$

## Алгоритм

### Вход алгоритма

+ Параметры области моделирования: $x_0$, $y_0$, $z_0$, $D_x$, $D_y$, $D_z$
+ Параметр уравнения a
+ Значения функции правой части $\rho(x,y,z)$ в области $\Omega$
+ Значения искомой функции $\phi(x,y,z)$ на границе области $\Omega$
+ Начальное приближение решения во внутренней части области $\Omega$
+ Порог сходимости $\varepsilon$

### Шаги алгоритма

1. Задать значения искомой функции на границе области $\Omega$:

$$\phi_{i, j, k}=F(x_i, y_j, z_k)$$
при $i=0$, $i=N_x$,  $j=0$, $j=N_y$,  $k=0$, $k=N_z$

2. Задать начальное приближение во внутренней части области $\Omega$:

$$\phi_{i, j, k}^0$$
$i \in [1, N_x-1],$ $j \in [1, N_y-1],$ $k \in [1, N_z-1]$

3. Многократно вычислять очередное приближение искомой функции по формуле (2) до достижения условия (3)

### Выход алгоритма

+ Значения искомой функции $\phi_{i, j,k}$ в области $\Omega$

### Оценка точности

$$\Delta = \max_{i, j, k}\mid \phi_{i, j, k}^m - \phi_{i, j, k}^* \mid$$

где $\phi_{i, j, k}^m$ - вычисленное значение функции $\phi$ в узле $i,j,k$, $\phi_{i, j, k}^*$ - точное значение функции $\phi$ в узле $i,j,k$

## Общая схема распараллеливания алгоритмов на регулярных сетках

Далее приведена общая схема распараллеливания алгоритмов на регулярных сетках методом декомпозиции пространства. При использовании этого метода каждому параллельному процессу сопоставляется некоторая подобласть пространства моделирования. Поскольку для вычисления сеточных значений внутри области требуются значения с соседних узлов сетки, то в каждом процессе к локальной подобласти добавляются дополнительные элементы, дублирующие граничные элементы соседних подобластей. Таким образом, осуществляется декомпозиция пространства моделирования на подобласти с перекрытием границ.

Для распараллеливания задач с прямоугольными многомерными областями обычно используются декартовы топологии, например, "линейка", "двумерная решетка", "трехмерная решетка". Способы декомпозиции трехмерной области на различные декартовы топологии процессов показаны на рис. 2.

![Декомпозиция на "линейке" и на "двумерной решетке"](https://user-images.githubusercontent.com/90527574/230935924-7ed8c959-ce6e-4a8b-b2db-5a314ecfcdd9.png)
![Декомпозиция на "трёхмерной решетке"](https://user-images.githubusercontent.com/90527574/230936238-04c6f1a3-5d3d-4b9f-b80e-dca61cbc86ea.png)

При параллельной реализации представленного выше итерационного алгоритма порядок действий выглядит следующим образом: на каждой итерации все процессы одновременно вычисляют значения в своей подобласти (этап вычислений), после чего происходит обмен граничными значениями (этап обменов). Схема обменов границами подобластей для двумерного случая и решетки процессов 2×2 показана на Рис. 3.

![Схема обменов значениями границ подобластей](https://user-images.githubusercontent.com/90527574/232300392-763919f6-ca32-4918-a3c6-a722c59feeca.png)

Так как обмен данными между процессами является времяемкой операцией, имеет смысл выполнять коммуникации на фоне вычислений. В этом случае порядок действий на каждой итерации в каждом процессе выглядит следующим образом:

+ Вычисляются сеточные значения, прилегающие к границе локальной подобласти
+ Запускается асинхронный обмен граничных значений
+ Выполняется вычисление остальных точек подобласти
+ Ожидание завершения обменов

## Исходные данные задачи

Исходные данные для тестирования реализаций представленного метода и выполнения лабораторной работы можно взять следующие:
+ область моделирования: [-1;1] × [-1;1] × [-1;1]
+ искомая функция: $\phi(x, y, z)=x^2+y^2+z^2$
+ правая часть уравнения: $\rho(x, y, z)=6-a\phi(x, y, z)$
+ параметр уравнения: $a = 10^5$
+ порог сходимости: $\varepsilon = 10^{-8}$
+ начальное приближение: $\phi^0_{i, j, k}=0$

## Задание к лабораторной работе

1. Написать параллельную программу на языке C/C++ с использованием MPI, реализующую решение уравнения (1) методом Якоби в трехмерной области в случае одномерной декомпозиции области. Уделить внимание тому, чтобы обмены граничными значениями подобластей выполнялись на фоне счета.
2. Измерить время работы программы при использовании различного числа процессорных ядер: 1, 2, 4, 8, 16. Размеры сетки и порог сходимости подобрать таким образом, чтобы решение задачи на одном ядре занимало не менее 30 секунд. Построить графики зависимости времени работы программы, ускорения и эффективности распараллеливания от числа используемых ядер.
3. Выполнить профилирование программы с помощью MPE при использовании 16-и ядер. Убедиться, что коммуникации происходят на фоне счета.
